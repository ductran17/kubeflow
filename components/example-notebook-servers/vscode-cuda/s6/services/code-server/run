#!/command/with-contenv bash

# many tools default to using the home directory for runtime data.
# as we mount a PVC to the home directory, these files might have the wrong permissions.
# to avoid this, we set the runtime directory to a path that is NOT a persistent volume.
export XDG_RUNTIME_DIR="/tmp/runtime-${NB_USER}"
mkdir -p "${XDG_RUNTIME_DIR}"
chmod 700 "${XDG_RUNTIME_DIR}"

# Set up CUDA environment
export PATH=$PATH:/usr/local/cuda/bin
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda/lib64:/usr/local/cuda/extras/CUPTI/lib64
export CUDA_HOME=/usr/local/cuda
export CUDA_ROOT=/usr/local/cuda
export CUDA_PATH=/usr/local/cuda

# Change to home directory (PVC will be mounted here by Kubeflow)
cd "${HOME}" || { echo "ERROR: failed to cd to ${HOME}"; exit 1; }

echo "INFO: starting VS Code server with CUDA support..."
echo "INFO: NB_PREFIX=${NB_PREFIX}"
echo "INFO: HOME=${HOME}"
echo "INFO: USER=$(whoami)"

# Create config directory in non-persistent location
export CODE_SERVER_CONFIG_DIR="/tmp/code-server-config"
mkdir -p "${CODE_SERVER_CONFIG_DIR}"

# Create code-server config file with CORS and NB_PREFIX support
cat > "${CODE_SERVER_CONFIG_DIR}/config.yaml" << EOF
auth: none
bind-addr: "0.0.0.0:8888"
disable-telemetry: true
disable-update-check: true
extra-extensions-dir: "/opt/code-server/extensions"
socket: "/tmp/code-server.sock"
EOF

# Handle NB_PREFIX if it's set
if [ "${NB_PREFIX}" != "/" ] && [ -n "${NB_PREFIX}" ]; then
    echo "INFO: Setting up code-server for NB_PREFIX=${NB_PREFIX}"

    # For code-server, we need to use a proxy approach to handle the prefix properly
    # We'll use nginx as a reverse proxy if available
    if command -v nginx >/dev/null 2>&1; then
        # Create nginx config
        cat > /tmp/nginx.conf << NGINX_EOF
events {
    worker_connections 1024;
}
http {
    server {
        listen 0.0.0.0:8888;

        location ${NB_PREFIX}/ {
            proxy_pass http://127.0.0.1:8889/;
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto \$scheme;

            # Add CORS headers for iframe support
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type, Authorization";

            # Handle WebSocket
            proxy_http_version 1.1;
            proxy_set_header Upgrade \$http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
NGINX_EOF

        # Start code-server on different port
        code-server \
            --bind-addr=127.0.0.1:8889 \
            --config="${CODE_SERVER_CONFIG_DIR}" &

        # Start nginx as reverse proxy
        exec nginx -c /tmp/nginx.conf -g "daemon off;"
    else
        echo "WARNING: nginx not found, running without NB_PREFIX support"
    fi
fi

# Start code-server normally if no special handling needed
exec 2>&1
exec code-server \
    --bind-addr=0.0.0.0:8888 \
    --config="${CODE_SERVER_CONFIG_DIR}"