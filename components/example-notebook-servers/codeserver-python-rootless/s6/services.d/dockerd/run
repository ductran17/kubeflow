#!/usr/bin/with-contenv bash
# shellcheck shell=bash

set -e

echo "=== Starting Rootless Docker Daemon ==="

# Source conda environment
. /opt/conda/etc/profile.d/conda.sh
conda activate base

# Set Docker environment variables
export DOCKER_HOST="unix:///home/jovyan/.local/share/docker/docker.sock"
export DOCKER_CONFIG="/home/jovyan/.config/docker"
export XDG_RUNTIME_DIR="/tmp"
export XDG_DATA_HOME="/home/jovyan/.local/share"
export XDG_CONFIG_HOME="/home/jovyan/.config"

# Enable cgroup v2 support (needed for recent Docker versions)
echo "Enabling cgroup v2 delegation..."
echo "+memory" > /sys/fs/cgroup/memory/memory.kmem.tcp.enable 2>/dev/null || true

# Start dockerd as jovyan user in rootless mode
exec su - jovyan -c "
    export DOCKER_HOST='unix:///home/jovyan/.local/share/docker/docker.sock'
    export DOCKER_CONFIG='/home/jovyan/.config/docker'
    export XDG_RUNTIME_DIR='/tmp'
    export XDG_DATA_HOME='/home/jovyan/.local/share'
    export XDG_CONFIG_HOME='/home/jovyan/.config'

    exec dockerd \
        --rootless \
        --host=unix:///home/jovyan/.local/share/docker/docker.sock \
        --data-root=/home/jovyan/.local/share/docker \
        --config-file=/home/jovyan/.config/docker/daemon.json \
        --log-level=info \
        --exec-root=/home/jovyan/.local/share/docker/exec
" 2>&1